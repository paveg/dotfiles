#!/bin/bash
# Install packages before setting up dotfiles

set -euo pipefail

# Skip package installation in CI if requested
if [[ -n "${CI_SKIP_PACKAGES:-}" ]]; then
    echo "=== Skipping package installation (CI_SKIP_PACKAGES set) ==="
    exit 0
fi

echo "=== Installing packages ==="

{{- if eq .chezmoi.os "darwin" }}
# macOS: Use Homebrew
if ! command -v brew >/dev/null 2>&1; then
    echo "Installing Homebrew..."
    /bin/bash -c "$(curl -fsSL https://raw.githubusercontent.com/Homebrew/install/HEAD/install.sh)"

    # Add Homebrew to PATH for this session
    if [[ -f "{{ .homebrew_prefix }}/bin/brew" ]]; then
        eval "$({{ .homebrew_prefix }}/bin/brew shellenv)"
    fi
fi

echo "Installing packages from Brewfile..."
# Use --no-upgrade to avoid conflicts with existing installations
brew bundle --file="{{ .chezmoi.sourceDir }}/homebrew/{{ if .business_use }}Brewfile.work{{ else }}Brewfile{{ end }}" --no-upgrade || {
    echo "Warning: Some packages failed to install. This is often due to already installed packages."
    echo "You can run 'brew bundle check' to see what's missing."
}

{{- else if eq .chezmoi.os "linux" }}
# Linux: Use native package managers (no Homebrew)

# Function to install atuin on Linux (not available in most repos)
install_atuin_linux() {
    if command -v atuin >/dev/null 2>&1; then
        echo "atuin is already installed"
        return 0
    fi

    echo "Installing atuin via precompiled binary..."

    # Create temporary directory
    local temp_dir=$(mktemp -d)
    cd "$temp_dir"

    # Download and install atuin
    curl -LsSf https://setup.atuin.sh | sh || {
        echo "Warning: Failed to install atuin via setup script"
        # Fallback: try to install via cargo if available
        if command -v cargo >/dev/null 2>&1; then
            echo "Attempting to install atuin via cargo..."
            cargo install atuin || echo "Warning: Failed to install atuin via cargo"
        fi
    }

    # Cleanup
    cd - >/dev/null
    rm -rf "$temp_dir"
}

if command -v apt >/dev/null 2>&1; then
    echo "Using apt package manager..."
    sudo apt update

    # Install packages from apt.txt
    echo "Installing packages from apt.txt..."
    while IFS= read -r package || [[ -n "$package" ]]; do
        # Skip comments and empty lines
        [[ "$package" =~ ^[[:space:]]*# ]] || [[ -z "$package" ]] && continue
        echo "Installing: $package"
        sudo apt install -y "$package" || echo "Warning: Failed to install $package"
    done < "{{ .chezmoi.sourceDir }}/packages/apt.txt"

    # Install atuin separately (not available in apt repos)
    install_atuin_linux

elif command -v dnf >/dev/null 2>&1; then
    echo "Using dnf package manager..."

    # Install packages from dnf.txt
    echo "Installing packages from dnf.txt..."
    while IFS= read -r package || [[ -n "$package" ]]; do
        # Skip comments and empty lines
        [[ "$package" =~ ^[[:space:]]*# ]] || [[ -z "$package" ]] && continue
        echo "Installing: $package"
        sudo dnf install -y "$package" || echo "Warning: Failed to install $package"
    done < "{{ .chezmoi.sourceDir }}/packages/dnf.txt"

    # Install atuin separately (not available in dnf repos)
    install_atuin_linux

elif command -v pacman >/dev/null 2>&1; then
    echo "Using pacman package manager..."

    # Install packages from pacman.txt
    echo "Installing packages from pacman.txt..."
    while IFS= read -r package || [[ -n "$package" ]]; do
        # Skip comments and empty lines
        [[ "$package" =~ ^[[:space:]]*# ]] || [[ -z "$package" ]] && continue
        echo "Installing: $package"
        sudo pacman -S --noconfirm "$package" || echo "Warning: Failed to install $package"
    done < "{{ .chezmoi.sourceDir }}/packages/pacman.txt"

else
    echo "No supported package manager found. Please install dependencies manually."
    echo "Required packages listed in {{ .chezmoi.sourceDir }}/packages/"
fi

# Install latest NeoVim on Linux
echo "=== Installing latest NeoVim ==="
if [[ -f "{{ .chezmoi.sourceDir }}/scripts/install-neovim-latest.sh" ]]; then
    echo "Running latest NeoVim installation script..."
    bash "{{ .chezmoi.sourceDir }}/scripts/install-neovim-latest.sh" || {
        echo "Warning: Latest NeoVim installation may have failed"
        echo "Falling back to package manager version if available"
    }
else
    echo "Warning: NeoVim installation script not found"
fi

# Install special tools on Linux using unified installer
echo "=== Installing Linux tools (gh, mise, ghq, delta, lazygit) ==="
if [[ -f "{{ .chezmoi.sourceDir }}/scripts/install-linux-tools.sh" ]]; then
    echo "Running unified Linux tools installation script..."
    bash "{{ .chezmoi.sourceDir }}/scripts/install-linux-tools.sh" gh mise ghq || {
        echo "Warning: Some tools may have failed to install"
        echo "You can run the script manually later: ~/.local/share/chezmoi/scripts/install-linux-tools.sh"
    }
else
    echo "Warning: Linux tools installation script not found"
fi

{{- end }}

# Install Rust tools via cargo (cross-platform)
echo "=== Installing Rust-based tools ==="
if [[ -f "{{ .chezmoi.sourceDir }}/scripts/install-rust-tools.sh" ]]; then
    echo "Running Rust tools installation script (with pre-built binaries + parallel install)..."
    bash "{{ .chezmoi.sourceDir }}/scripts/install-rust-tools.sh" || {
        echo "Warning: Some Rust tools may have failed to install"
        echo "You can run the script manually later: ~/.local/share/chezmoi/scripts/install-rust-tools.sh"
    }
else
    echo "Warning: Rust tools installation script not found"
fi

echo "âœ“ Package installation completed"
